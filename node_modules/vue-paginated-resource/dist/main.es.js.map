{"version":3,"file":"main.es.js","sources":["../src/utils.ts","../src/watchers.ts","../src/core.ts"],"sourcesContent":["export const keysOf = <ObjectType>(object: ObjectType) => (\n  Object.keys(object) as Array<keyof ObjectType>\n);\n","import { watch } from 'vue';\nimport { keysOf } from '@/utils';\n\nimport type { WatchCallback } from 'vue';\n\nexport const watchReactiveObjectKeys = <ObjectType extends Record<string, unknown>>(\n  object: ObjectType,\n  callback: WatchCallback,\n) => watch(keysOf(object).map((key) => () => object[key]), callback);\n","import {\n  computed, ref, shallowRef, watch,\n} from 'vue';\nimport { watchReactiveObjectKeys } from '@/watchers';\n\nimport type { Ref } from 'vue';\nimport type { ComposableCreationOptions } from '@/types/composableCreation';\nimport type { PageRelatedRequestOptions, PaginatedRequestMethod } from '@/types/requests';\n\nexport const createPaginatedResourceComposable = <\n  PageKeyType extends string = 'page',\n  PageSizeKeyType extends string | undefined = undefined,\n>(composableOptions: ComposableCreationOptions<PageKeyType, PageSizeKeyType>) => {\n  const FRONTEND_PAGE_SIZE = composableOptions.frontend.pageSize;\n  const BACKEND_PAGE_SIZE = composableOptions.backend?.pageSize;\n  const BACKEND_PAGE_REQUEST_KEY = composableOptions.backend?.requestKeys?.page || 'page';\n  const BACKEND_PAGE_SIZE_REQUEST_KEY = composableOptions.backend?.requestKeys?.pageSize;\n\n  return <ElementType, OptionsType extends PageRelatedRequestOptions<PageKeyType, PageSizeKeyType>>(\n    paginatedRequestMethod: PaginatedRequestMethod<ElementType, OptionsType>,\n    page: Ref<number>,\n    resetPage: () => void,\n    requestOptions: Omit<\n      OptionsType,\n      keyof PageRelatedRequestOptions<PageKeyType, PageSizeKeyType>\n    >,\n  ) => {\n    const elements = shallowRef<Array<ElementType>>([]);\n    const loading = ref(false);\n    const total = ref(0);\n    const backendPage = ref(0);\n\n    const firstElement = computed(\n      () => FRONTEND_PAGE_SIZE * (page.value - 1),\n    );\n    const nextElement = computed(() => FRONTEND_PAGE_SIZE * page.value);\n    const remainingElements = computed(() => elements.value.length - nextElement.value);\n    const previousPageAvailable = computed(() => page.value > 1);\n    const nextPageAvailable = computed(() => (\n      (!loading.value || (nextElement.value < elements.value.length))\n      && (nextElement.value < total.value)\n    ));\n    const pageLimits = computed(() => ({\n      firstElement: firstElement.value,\n      lastElement: Math.min(\n        firstElement.value + FRONTEND_PAGE_SIZE - 1,\n        total.value - 1,\n      ),\n    }));\n\n    const pageElements = computed(\n      () => elements.value.slice(firstElement.value, nextElement.value),\n    );\n\n    const requestNextPage = async () => {\n      loading.value = true;\n      backendPage.value += 1;\n\n      // @ts-expect-error: The union of the page-related keys isn't perfect\n      const pageRelatedRequestOptions: PageRelatedRequestOptions<PageKeyType, PageSizeKeyType> = {\n        [BACKEND_PAGE_REQUEST_KEY as PageKeyType]: backendPage.value,\n        ...(\n          BACKEND_PAGE_SIZE_REQUEST_KEY !== undefined && {\n            [BACKEND_PAGE_SIZE_REQUEST_KEY as NonNullable<PageSizeKeyType>]: (\n              BACKEND_PAGE_SIZE as number\n            ),\n          }\n        ),\n      };\n\n      // @ts-expect-error: The union of the `requestOptions` and the page-related keys isn't perfect\n      const internalRequestOptions: OptionsType = {\n        ...pageRelatedRequestOptions,\n        ...requestOptions,\n      };\n      const {\n        total: requestTotal,\n        elements: requestElements,\n      } = await paginatedRequestMethod(internalRequestOptions);\n      total.value = requestTotal;\n      if (requestElements.length > 0) {\n        elements.value = [...elements.value, ...requestElements];\n      } else {\n        backendPage.value -= 1;\n      }\n      loading.value = false;\n    };\n\n    watchReactiveObjectKeys(requestOptions, () => {\n      elements.value = [];\n      backendPage.value = 0;\n      resetPage();\n      requestNextPage();\n    });\n\n    watch(() => page.value, () => {\n      if (\n        elements.value.length > 0\n        && (remainingElements.value < (2 * FRONTEND_PAGE_SIZE))\n        && elements.value.length < total.value\n      ) {\n        requestNextPage();\n      }\n    });\n\n    requestNextPage();\n\n    return {\n      total,\n      pageElements,\n      loading,\n      previousPageAvailable,\n      nextPageAvailable,\n      pageLimits,\n    };\n  };\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AAAO,MAAM,SAAS,CAAa,WACjC,OAAO,KAAK,MAAM;ACIb,MAAM,0BAA0B,CACrC,QACA,aACG,MAAM,OAAO,MAAM,EAAE,IAAI,CAAC,QAAQ,MAAM,OAAO,IAAI,GAAG,QAAQ;ACCtD,MAAA,oCAAoC,CAG/C,sBAA+E;;AACzE,QAAA,qBAAqB,kBAAkB,SAAS;AAChD,QAAA,oBAAoB,wBAAkB,YAAlB,mBAA2B;AACrD,QAAM,2BAA2B,+BAAkB,YAAlB,mBAA2B,gBAA3B,mBAAwC,SAAQ;AAC3E,QAAA,gCAAgC,8BAAkB,YAAlB,mBAA2B,gBAA3B,mBAAwC;AAE9E,SAAO,CACL,wBACA,MACA,WACA,mBAIG;AACG,UAAA,WAAW,WAA+B,CAAA,CAAE;AAC5C,UAAA,UAAU,IAAI,KAAK;AACnB,UAAA,QAAQ,IAAI,CAAC;AACb,UAAA,cAAc,IAAI,CAAC;AAEzB,UAAM,eAAe,SACnB,MAAM,qBAAsB,MAAK,QAAQ,EAC3C;AACA,UAAM,cAAc,SAAS,MAAM,qBAAqB,KAAK,KAAK;AAClE,UAAM,oBAAoB,SAAS,MAAM,SAAS,MAAM,SAAS,YAAY,KAAK;AAClF,UAAM,wBAAwB,SAAS,MAAM,KAAK,QAAQ,CAAC;AAC3D,UAAM,oBAAoB,SAAS,MAChC,EAAC,QAAQ,SAAU,YAAY,QAAQ,SAAS,MAAM,WACnD,YAAY,QAAQ,MAAM,KAC/B;AACK,UAAA,aAAa,SAAS,MAAO;AAAA,MACjC,cAAc,aAAa;AAAA,MAC3B,aAAa,KAAK,IAChB,aAAa,QAAQ,qBAAqB,GAC1C,MAAM,QAAQ,CAChB;AAAA,IACA,EAAA;AAEI,UAAA,eAAe,SACnB,MAAM,SAAS,MAAM,MAAM,aAAa,OAAO,YAAY,KAAK,CAClE;AAEA,UAAM,kBAAkB,YAAY;AAClC,cAAQ,QAAQ;AAChB,kBAAY,SAAS;AAGrB,YAAM,4BAAqF;AAAA,SACxF,2BAA0C,YAAY;AAAA,SAErD,kCAAkC,UAAa;AAAA,SAC5C,gCACC;AAAA,MAEJ;AAKJ,YAAM,yBAAsC,kCACvC,4BACA;AAEC,YAAA;AAAA,QACJ,OAAO;AAAA,QACP,UAAU;AAAA,UACR,MAAM,uBAAuB,sBAAsB;AACvD,YAAM,QAAQ;AACV,UAAA,gBAAgB,SAAS,GAAG;AAC9B,iBAAS,QAAQ,CAAC,GAAG,SAAS,OAAO,GAAG,eAAe;AAAA,MAAA,OAClD;AACL,oBAAY,SAAS;AAAA,MACvB;AACA,cAAQ,QAAQ;AAAA,IAAA;AAGlB,4BAAwB,gBAAgB,MAAM;AAC5C,eAAS,QAAQ;AACjB,kBAAY,QAAQ;AACV;AACM;IAAA,CACjB;AAEK,UAAA,MAAM,KAAK,OAAO,MAAM;AAC5B,UACE,SAAS,MAAM,SAAS,KACpB,kBAAkB,QAAS,IAAI,sBAChC,SAAS,MAAM,SAAS,MAAM,OACjC;AACgB;MAClB;AAAA,IAAA,CACD;AAEe;AAET,WAAA;AAAA,MACL;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IAAA;AAAA,EACF;AAEJ;;"}